{"version":3,"sources":["../../../../app/actions/update-status.tsx"],"sourcesContent":["\"use server\";\n\nimport { createServerClient, type CookieOptions } from \"@supabase/ssr\";\nimport { cookies } from \"next/headers\";\nimport { revalidatePath } from \"next/cache\";\n\nexport async function updateStatus(applicationId: string, newStatus: string) {\n    const cookieStore = await cookies();\n    const supabase = createServerClient(\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\n        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n        {\n            cookies: {\n                get(name: string) {\n                    return cookieStore.get(name)?.value;\n                },\n                set(name: string, value: string, options: CookieOptions) {\n                    cookieStore.set({ name, value, ...options });\n                },\n                remove(name: string, options: CookieOptions) {\n                    cookieStore.set({ name, value: \"\", ...options });\n                },\n            },\n        }\n    );\n\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n        throw new Error(\"Unauthorized: You must be logged in to perform this action.\");\n    }\n\n    // Optional: Add specific email check for \"Super Admin\" if needed\n    // if (user.email !== 'admin@usvpc.com') throw new Error(\"Forbidden\");\n\n    const { error } = await supabase\n        .from(\"applications\")\n        .update({ status: newStatus })\n        .eq(\"id\", applicationId);\n\n    if (error) {\n        throw new Error(error.message);\n    }\n\n    // Trigger Email if Completed\n    if (newStatus === 'completed_delivered') {\n        try {\n            // 1. Fetch full application data\n            const { data: appData } = await supabase\n                .from(\"applications\")\n                .select(`*, profiles (email)`)\n                .eq(\"id\", applicationId)\n                .single();\n\n\n            const locale = appData.client_metadata?.locale || 'es';\n            const { getTranslations } = await import('next-intl/server');\n            const t = await getTranslations({ locale, namespace: 'Email' });\n\n            // 2. Generate PDF\n            // Note: We import dynamically to avoid build issues if not needed elsewhere\n            const { renderToBuffer } = await import('@react-pdf/renderer');\n            const { DS160Document } = await import('@/components/pdf/DS160Document');\n\n            const pdfBuffer = await renderToBuffer(<DS160Document data={appData.ds160_payload} />);\n\n            // 3. Send Email\n            const { sendEmail } = await import('@/lib/email/client');\n            await sendEmail({\n                to: appData.profiles.email,\n                subject: t('applicationCompletedSubject'),\n                html: `\n                        <h1>${t('applicationCompletedHeader')}</h1>\n                        <p>${t('dearApplicant')}</p>\n                        <p>${t('applicationProcessed')}</p>\n                        <p>${t('findAttached')}</p>\n                        <br/>\n                        <p>${t('bestRegards')}</p>\n                        <p>${t('companyName')}</p>\n                    `,\n                attachments: [\n                    {\n                        filename: `DS160_${appData.id}.pdf`,\n                        content: pdfBuffer\n                    }\n                ]\n            });\n        } catch (emailError) {\n            console.error(\"Failed to send completion email:\", emailError);\n            // Don't fail the status update just because email failed, but log it\n        }\n    }\n\n    revalidatePath(\"/admin\");\n    revalidatePath(\"/dashboard\");\n    return { success: true };\n}\n"],"names":[],"mappings":"oEAEA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,MACA,EAAA,EAAA,CAAA,CAAA,MACA,EAAA,EAAA,CAAA,CAAA,OAEO,eAAe,EAAa,CAAqB,CAAE,CAAiB,EACvE,IAAM,EAAc,MAAM,CAAA,EAAA,EAAA,OAAO,AAAP,IACpB,EAAW,CAAA,EAAA,EAAA,kBAAA,AAAkB,EAAA,2CAAA,mNAG/B,CACI,QAAS,KACL,AAAI,GACO,CADK,CACO,GAAG,CAAC,IAAO,MAElC,IAAI,CAAY,CAAE,CAAa,CAAE,CAAsB,EACnD,EAAY,GAAG,CAAC,MAAE,QAAM,EAAO,GAAG,CAAO,AAAC,EAC9C,EACA,OAAO,CAAY,CAAE,CAAsB,EACvC,EAAY,GAAG,CAAC,MAAE,EAAM,MAAO,GAAI,GAAG,CAAO,AAAC,EAClD,CACJ,CACJ,GAGE,CAAE,KAAM,MAAE,CAAI,CAAE,CAAE,MAAO,CAAS,CAAE,CAAG,MAAM,EAAS,IAAI,CAAC,OAAO,GAExE,GAAI,GAAa,CAAC,EACd,IADoB,EACd,AAAI,MAAM,+DAMpB,GAAM,CAAE,OAAK,CAAE,CAAG,MAAM,EACnB,IAAI,CAAC,gBACL,MAAM,CAAC,CAAE,OAAQ,CAAU,GAC3B,EAAE,CAAC,KAAM,GAEd,GAAI,EACA,KADO,CACD,AAAI,MAAM,EAAM,OAAO,EAIjC,GAAI,AAAc,uBAAuB,GACrC,GAAI,CAEA,GAAM,CAAE,KAAM,CAAO,CAAE,CAAG,MAAM,EAC3B,IAAI,CAAC,gBACL,MAAM,CAAC,CAAC,mBAAmB,CAAC,EAC5B,EAAE,CAAC,KAAM,GACT,MAAM,GAGL,EAAS,EAAQ,eAAe,EAAE,QAAU,KAC5C,iBAAE,CAAe,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OACtB,EAAI,MAAM,EAAgB,QAAE,EAAQ,UAAW,OAAQ,GAIvD,gBAAE,CAAc,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,MACrB,eAAE,CAAa,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,OAEpB,EAAY,MAAM,EAAe,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,CAAc,KAAM,EAAQ,aAAa,IAG3E,WAAE,CAAS,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,MACtB,OAAM,EAAU,CACZ,GAAI,EAAQ,QAAQ,CAAC,KAAK,CAC1B,QAAS,EAAE,+BACX,KAAM,CAAC;4BACK,EAAE,EAAE,8BAA8B;2BACnC,EAAE,EAAE,iBAAiB;2BACrB,EAAE,EAAE,wBAAwB;2BAC5B,EAAE,EAAE,gBAAgB;;2BAEpB,EAAE,EAAE,eAAe;2BACnB,EAAE,EAAE,eAAe;oBAC1B,CAAC,CACL,YAAa,CACT,CACI,SAAU,CAAC,MAAM,EAAE,EAAQ,EAAE,CAAC,IAAI,CAAC,CACnC,QAAS,CACb,EACH,AACL,EACJ,CAAE,MAAO,EAAY,CACjB,QAAQ,KAAK,CAAC,mCAAoC,EAEtD,CAKJ,MAFA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,UACf,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cACR,CAAE,SAAS,CAAK,CAC3B,0CA1FsB,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA"}