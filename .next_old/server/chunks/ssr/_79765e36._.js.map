{"version":3,"sources":["../../../../lib/auth/current-user.ts","../../../../app/actions/ds160.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { cookies } from \"next/headers\";\n\nexport type DevUserRole = 'client' | 'admin' | 'agent' | 'client_fresh';\n\nexport const DEV_USERS: Record<DevUserRole, { id: string; email: string; role: DevUserRole }> = {\n    client: {\n        id: '00000000-0000-0000-0000-000000000001',\n        email: 'dev_applicant@example.com',\n        role: 'client'\n    },\n    admin: {\n        id: '00000000-0000-0000-0000-000000000002',\n        email: 'dev_admin@example.com',\n        role: 'admin'\n    },\n    agent: {\n        id: '00000000-0000-0000-0000-000000000003',\n        email: 'dev_agent@example.com',\n        role: 'agent'\n    },\n    client_fresh: {\n        id: '00000000-0000-0000-0000-000000000004',\n        email: 'dev_fresh@example.com',\n        role: 'client_fresh'\n    }\n};\n\nexport async function getCurrentUser() {\n    const cookieStore = await cookies();\n    const isDev = process.env.NEXT_PUBLIC_DEV_MODE === 'true';\n\n    // 1. Dev Mode Bypass\n    if (isDev) {\n        const devUserRole = cookieStore.get('x-dev-user')?.value as DevUserRole | undefined;\n        if (devUserRole && DEV_USERS[devUserRole]) {\n            const devUser = DEV_USERS[devUserRole];\n            // Return structure matching supabase.auth.getUser()\n            return {\n                data: {\n                    user: {\n                        id: devUser.id,\n                        email: devUser.email,\n                        role: 'authenticated', // Supabase Auth role\n                        aud: 'authenticated',\n                        app_metadata: { provider: 'email' },\n                        user_metadata: { name: `Dev ${devUserRole.charAt(0).toUpperCase() + devUserRole.slice(1)}` },\n                        created_at: new Date().toISOString(),\n                    }\n                },\n                error: null\n            };\n        }\n    }\n\n    // 2. Real Supabase Auth\n    const supabase = createServerClient(\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\n        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n        {\n            cookies: {\n                get(name: string) {\n                    return cookieStore.get(name)?.value;\n                },\n                set(name: string, value: string, options: any) {\n                    try {\n                        cookieStore.set({ name, value, ...options });\n                    } catch (error) {\n                        // The `set` method was called from a Server Component.\n                        // This can be ignored if you have middleware refreshing\n                        // user sessions.\n                    }\n                },\n                remove(name: string, options: any) {\n                    try {\n                        cookieStore.set({ name, value: '', ...options });\n                    } catch (error) {\n                        // The `delete` method was called from a Server Component.\n                        // This can be ignored if you have middleware refreshing\n                        // user sessions.\n                    }\n                },\n            },\n        }\n    );\n\n    return await supabase.auth.getUser();\n}\n","\"use server\";\n\nimport { createServerClient } from \"@supabase/ssr\";\nimport { cookies } from \"next/headers\";\nimport { revalidatePath } from \"next/cache\";\nimport { getCurrentUser } from \"@/lib/auth/current-user\";\n\nexport async function resetDS160Field(fieldKey: string) {\n    const { data: { user } } = await getCurrentUser();\n    if (!user) throw new Error(\"Unauthorized\");\n\n    const cookieStore = await cookies();\n    const supabase = createServerClient(\n        process.env.NEXT_PUBLIC_SUPABASE_URL!,\n        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n        {\n            cookies: {\n                get(name: string) { return cookieStore.get(name)?.value; },\n            },\n        }\n    );\n\n    // 1. Fetch current payload\n    const { data: app, error: fetchError } = await supabase\n        .from(\"applications\")\n        .select(\"ds160_payload\")\n        .eq(\"user_id\", user.id)\n        .single();\n\n    if (fetchError || !app) throw new Error(\"Application not found\");\n\n    // 2. Set field to null (Deep update)\n    const payload = app.ds160_payload;\n    const keys = fieldKey.split('.');\n    let current = payload;\n\n    // Navigate to parent\n    for (let i = 0; i < keys.length - 1; i++) {\n        if (!current[keys[i]]) current[keys[i]] = {};\n        current = current[keys[i]];\n    }\n\n    // Set value to null\n    current[keys[keys.length - 1]] = null;\n\n    // 3. Save back\n    const { error: updateError } = await supabase\n        .from(\"applications\")\n        .update({ ds160_payload: payload })\n        .eq(\"user_id\", user.id);\n\n    if (updateError) throw new Error(updateError.message);\n\n    revalidatePath(\"/dashboard\");\n    return { success: true };\n}\n"],"names":[],"mappings":"uCAAA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,MACA,EAAA,EAAA,CAAA,CAAA,MAIO,IAAM,EAAmF,CAC5F,OAAQ,CACJ,GAAI,uCACJ,MAAO,4BACP,KAAM,QACV,EACA,MAAO,CACH,GAAI,uCACJ,MAAO,wBACP,KAAM,OACV,EACA,MAAO,CACH,GAAI,uCACJ,MAAO,wBACP,KAAM,OACV,EACA,aAAc,CACV,GAAI,uCACJ,MAAO,wBACP,KAAM,cACV,CACJ,EAEO,eAAe,IAClB,IAAM,EAAc,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,GAItB,EACP,IAAM,EAAc,EAAY,GAAG,CAAC,eAAe,MACnD,GAAI,GAAe,CAAS,CAAC,EAAY,CAAE,CACvC,IAAM,EAAU,CAAS,CAAC,EAAY,CAEtC,MAAO,CACH,KAAM,CACF,KAAM,CACF,GAAI,EAAQ,EAAE,CACd,MAAO,EAAQ,KAAK,CACpB,KAAM,gBACN,IAAK,gBACL,aAAc,CAAE,SAAU,OAAQ,EAClC,cAAe,CAAE,KAAM,CAAC,IAAI,EAAE,EAAY,MAAM,CAAC,GAAG,WAAW,GAAK,EAAY,KAAK,CAAC,GAAA,CAAI,AAAC,EAC3F,WAAY,IAAI,OAAO,WAAW,EACtC,CACJ,EACA,MAAO,IACX,CACJ,CACJ,CAGA,IAAM,EAAW,CAAA,EAAA,EAAA,kBAAA,AAAkB,EAAA,2CAAA,mNAG/B,CACI,QAAS,CACL,IAAI,GACO,CADK,CACO,GAAG,CAAC,IAAO,MAElC,IAAI,CAAY,CAAE,CAAa,CAAE,CAAY,EACzC,GAAI,CACA,EAAY,GAAG,CAAC,MAAE,EAAM,QAAO,GAAG,CAAO,AAAC,EAC9C,CAAE,MAAO,EAAO,CAIhB,CACJ,EACA,OAAO,CAAY,CAAE,CAAY,EAC7B,GAAI,CACA,EAAY,GAAG,CAAC,MAAE,EAAM,MAAO,GAAI,GAAG,CAAO,AAAC,EAClD,CAAE,MAAO,EAAO,CAIhB,CACJ,CACJ,CACJ,GAGJ,OAAO,MAAM,EAAS,IAAI,CAAC,OAAO,EACtC,wFCrFA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,MACA,EAAA,EAAA,CAAA,CAAA,MACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAEO,eAAe,EAAgB,CAAgB,EAClD,GAAM,CAAE,KAAM,MAAE,CAAI,CAAE,CAAE,CAAG,MAAM,CAAA,EAAA,EAAA,cAAA,AAAc,IAC/C,GAAI,CAAC,EAAM,MAAM,AAAI,MAAM,gBAE3B,IAAM,EAAc,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,IAC3B,EAAW,CAAA,EAAA,EAAA,kBAAA,AAAkB,EAAA,2CAAA,mNAG/B,CACI,QAAS,KACL,AAAI,GAAuB,CAAX,CAAuB,GAAG,CAAC,IAAO,KACtD,CACJ,GAIE,CAAE,KAAM,CAAG,CAAE,MAAO,CAAU,CAAE,CAAG,MAAM,EAC1C,IAAI,CAAC,gBACL,MAAM,CAAC,iBACP,EAAE,CAAC,UAAW,EAAK,EAAE,EACrB,MAAM,GAEX,GAAI,GAAc,CAAC,EAAK,MAAM,AAAI,MAAM,yBAGxC,IAAM,EAAU,EAAI,aAAa,CAC3B,EAAO,EAAS,KAAK,CAAC,KACxB,EAAU,EAGd,IAAK,IAAI,EAAI,EAAG,EAAI,EAAK,MAAM,CAAG,EAAG,IAAK,AAClC,AAAC,CAAO,CAAC,CAAI,CAAC,EAAE,CAAC,GAAE,CAAO,CAAC,CAAI,CAAC,EAAE,CAAC,CAAG,EAAC,EAC3C,EAAU,CAAO,CAAC,CAAI,CAAC,EAAE,CAAC,CAI9B,CAAO,CAAC,CAAI,CAAC,EAAK,MAAM,CAAG,EAAE,CAAC,CAAG,KAGjC,GAAM,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EAChC,IAAI,CAAC,gBACL,MAAM,CAAC,CAAE,cAAe,CAAQ,GAChC,EAAE,CAAC,UAAW,EAAK,EAAE,EAE1B,GAAI,EAAa,MAAM,AAAI,MAAM,EAAY,OAAO,EAGpD,MADA,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,cACR,CAAE,QAAS,EAAK,CAC3B,0CAhDsB,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA"}